"""
MCP Server: Market Data API Tools

Focus: High-level user-facing tools that orchestrate data retrieval and transformation.
Delegates to web_api_client for API calls and utils for data transformation.
"""
import json
import time
from typing import Optional, List
from fastmcp import FastMCP
from settings import DEFAULT_FIELDS

from utils import get_market_data_of_predefined_watchlist

from ibind_web_client import (
    get_conids, 
    get_client,
    get_historical_data_by_conid,
)

server = FastMCP("market-analysis-server")

@server.tool()
async def list_mcp_tools() -> str:
    """List available market analysis tools and their purposes"""
    return """Available Market Analysis Tools:

1. SYMBOL LOOKUP:
   - get_symbol_details_ibkr(symbol): Search and retrieve contract details for a ticker symbol

2. REAL-TIME MARKET DATA:
   - get_market_snapshot_ibkr(symbols): Get real-time prices (bid/ask/last price)
   - get_market_data_enhanced_ibkr(symbols, include_bid_ask): Get enhanced data with volatility metrics
   - watch_symbols_ibkr(symbols): Monitor symbols for real-time updates

3. ACCOUNT & PORTFOLIO:
   - get_account_summary_ibkr(): List connected brokerage accounts
   - get_portfolio_positions_ibkr(account_id): Get current holdings, quantities, and P&L

4. HISTORICAL DATA (Single Symbol/Contract):
   - get_historical_data_by_conid_ibkr(conid, bar, period): Historical OHLC by contract ID
   - get_historical_data_by_symbol_ibkr(symbol, bar, period): Historical OHLC by symbol (auto-resolves to conid)

5. HISTORICAL DATA (Batch - Multiple Symbols/Contracts):
   - get_historical_data_batch_by_conids_ibkr(conids, bar, period): Batch historical by conids (parallel processing)
   - get_historical_data_batch_by_symbols_ibkr(symbols, bar, period): Batch historical by symbols (parallel processing)

6. MARKET ANALYSIS (Pre-defined Watchlist):
   - get_market_snapshot_of_predefined_watchlist(): Get snapshot of predefined watchlist for context

7. LLM & PROMPTS:
   - get_custom_prompt(): Retrieve custom prompt instructions for market analysis
   - analyze_question(question): Analyze market question with external LLM
   - generate_narrative(): Generate detailed market narrative with external LLM"""


# ============================================================================
# TOOL: Symbol Lookup
# ============================================================================

@server.tool()
async def get_symbol_details(symbol: str) -> str:
    """
    Search for and retrieve contract details for a symbol.
    
    Args:
        symbol: Ticker symbol to search for (e.g., 'AAPL')
    
    Returns:
        JSON string with contract information including conid, description, exchange.
    """
    try:
        client = get_client()
        if client is None:
            return json.dumps({"error": "IBKR client not initialized"})
        
        result = client.search_contract_by_symbol(symbol)
        
        if not result.data or len(result.data) == 0:
            return json.dumps({"error": f"No contracts found for symbol: {symbol}"})
        
        contracts = result.data[:5]
        response = {
            "symbol": symbol,
            "matches": contracts,
            "count": len(contracts)
        }
        return json.dumps(response, indent=2)
    
    except Exception as e:
        return json.dumps({"error": f"Symbol lookup failed: {str(e)}"})

# ============================================================================
# TOOLS: Real-Time Market Data 
# ============================================================================

@server.tool()
async def get_watchlist_market_data(symbols: List[str], fields: List[str] = DEFAULT_FIELDS) -> str:
    """
    Get real-time market data of a watchlist of multiple symbols.
    
    Args:
        symbols: List of ticker symbols (e.g., ['AAPL', 'MSFT', 'GOOGL'])
        fields: List of data fields to retrieve (default: ['last', 'bid', 'ask'])
    
    Returns:
        JSON string with market data including last price, bid, ask for each conid.
    """
    try:
        conids = get_conids(symbols)
        if not conids:
            return json.dumps({"error": "Failed to resolve symbols to contract IDs", "symbols": symbols, "suggestion": "Try get_symbol_details_ibkr() to find correct symbols"})
        
        return get_market_data(conids=conids, fields=fields)
    
    except Exception as e:
        return json.dumps({"error": f"Market snapshot failed: {str(e)}"})

# ============================================================================
# TOOLS: Market Analysis Based on Pre-defined Symbol Set
# ============================================================================

@server.tool()
async def get_market_snapshot_of_predefined_watchlist() -> str:
    """Get current market snapshot of predefined watchlist of key instruments to serve as context, no analysis"""
    return get_market_data_of_predefined_watchlist()
    

# ============================================================================
# TOOLS: Account & Portfolio
# ============================================================================

@server.tool()
async def get_account_summary_ibkr() -> str:
    """
    Get summary of brokerage accounts connected to IBKR.
    
    Returns:
        JSON string with list of available accounts and their details.
    """
    try:
        client = get_client()
        if client is None:
            return json.dumps({"error": "IBKR client not initialized"})
        
        result = client.receive_brokerage_accounts()
        
        if not result.data:
            return json.dumps({"error": "No accounts available"})
        
        response = {
            "timestamp": time.strftime("%Y-%m-%d %H:%M:%S"),
            "accounts": result.data
        }
        return json.dumps(response, indent=2)
    
    except Exception as e:
        return json.dumps({"error": f"Account retrieval failed: {str(e)}"})


@server.tool()
async def get_portfolio_positions_ibkr(account_id: Optional[str] = None) -> str:
    """
    Get current portfolio positions for an account.
    
    Args:
        account_id: Account ID to retrieve positions for. If None, uses default account.
    
    Returns:
        JSON string with current positions, quantities, and values.
    """
    try:
        client = get_client()
        if client is None:
            return json.dumps({"error": "IBKR client not initialized"})
        
        if account_id is None:
            accounts_result = client.receive_brokerage_accounts()
            if not accounts_result.data or len(accounts_result.data) == 0:
                return json.dumps({"error": "No accounts available"})
            account_id = accounts_result.data[0]['account']
        
        result = client.get_portfolio(account_id=account_id)
        
        if not result.data:
            return json.dumps({"error": f"No positions found for account: {account_id}"})
        
        response = {
            "timestamp": time.strftime("%Y-%m-%d %H:%M:%S"),
            "account_id": account_id,
            "positions": result.data
        }
        return json.dumps(response, indent=2)
    
    except Exception as e:
        return json.dumps({"error": f"Portfolio retrieval failed: {str(e)}"})

# ============================================================================
# TOOLS: Historical Data (Single & Batch)
# ============================================================================

@server.tool()
async def get_historical_data_by_conid(conid: str, bar: str, period: Optional[str] = None, exchange: Optional[str] = None, outside_rth: bool = False) -> str:
    """
    Get historical market data for a given contract ID.
    
    Args:
        conid: Contract identifier
        bar: Bar size (e.g., "1min", "5min", "1h", "1d")
        period: Data duration (e.g., "1d", "1w", "1m", "1y")
        exchange: Specific exchange (optional)
        outside_rth: Include trades outside regular trading hours (default: False)
    
    Returns:
        JSON string with historical OHLC data
    """
    try:
        result, error = await get_historical_data_by_conid(conid, bar, period, exchange, outside_rth)
        if error:
            return json.dumps(error)
        
        response = {
            "timestamp": time.strftime("%Y-%m-%d %H:%M:%S"),
            "conid": conid,
            "bar": bar,
            "period": period,
            "data": result.data
        }
        return json.dumps(response, indent=2)
    
    except Exception as e:
        return json.dumps({"error": f"Historical data retrieval failed: {str(e)}"})


@server.tool()
async def get_historical_data_by_symbol_ibkr(symbol: str, bar: str, period: Optional[str] = None, exchange: Optional[str] = None, outside_rth: bool = False) -> str:
    """
    Get historical market data by symbol. Always resolves symbol to contract ID (conid).
    IBKR uses conid as the unique identifier; symbols can be ambiguous.
    
    Args:
        symbol: Ticker symbol or index (e.g., "AAPL", "VVIX")
        bar: Bar size (e.g., "1min", "5min", "1h", "1d")
        period: Data duration (e.g., "1d", "1w", "1m", "1y")
        exchange: Specific exchange (optional)
        outside_rth: Include trades outside regular trading hours (default: False)
    
    Returns:
        JSON string with historical OHLC data indexed by resolved conid
    """
    try:
        conids = get_conids([symbol])
        if not conids:
            return json.dumps({"error": f"Failed to resolve symbol '{symbol}' to contract ID", "symbol": symbol, "suggestion": f"Try get_symbol_details_ibkr('{symbol}') to find available contracts"})
        
        conid = str(conids[0])
        result, error = await get_historical_data_by_conid(conid, bar, period, exchange, outside_rth)
        if error:
            error["symbol_requested"] = symbol
            error["conid_resolved"] = conid
            return json.dumps(error)
        
        response = {
            "timestamp": time.strftime("%Y-%m-%d %H:%M:%S"),
            "symbol_requested": symbol,
            "conid_resolved": conid,
            "bar": bar,
            "period": period,
            "data": result.data
        }
        return json.dumps(response, indent=2)
    
    except Exception as e:
        return json.dumps({"error": f"Historical data retrieval failed: {str(e)}"})



if __name__ == "__main__":
    server.run()

# to run the server from command line:
# cd /home/john/CodingProjects/llm_public && PYTHONPATH=./src python src/mcp_server.py